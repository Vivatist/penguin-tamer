#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è flake8 –æ—à–∏–±–æ–∫
# Penguin Tamer Project
# –î–∞—Ç–∞: 2025-10-09

set -e

echo "üîß –ù–∞—á–∏–Ω–∞—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ flake8 –æ—à–∏–±–æ–∫..."
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å —Ü–≤–µ—Ç–æ–º
print_status() {
    echo -e "${GREEN}‚úì${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}‚ö†${NC} $1"
}

print_error() {
    echo -e "${RED}‚úó${NC} $1"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤..."

if ! command -v autopep8 &> /dev/null; then
    print_warning "autopep8 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é..."
    pip install autopep8
fi

if ! command -v autoflake &> /dev/null; then
    print_warning "autoflake –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é..."
    pip install autoflake
fi

print_status "–í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã"
echo ""

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
echo "üíæ –°–æ–∑–¥–∞—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é..."
BACKUP_DIR="backup_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"
cp -r src/ "$BACKUP_DIR/"
cp -r tests/ "$BACKUP_DIR/"
print_status "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞ –≤ $BACKUP_DIR"
echo ""

# 1. –£–¥–∞–ª–µ–Ω–∏–µ trailing whitespace
echo "üßπ –®–∞–≥ 1/6: –£–¥–∞–ª–µ–Ω–∏–µ trailing whitespace (W291)..."
autopep8 --in-place --select=W291 --recursive src/ tests/
print_status "Trailing whitespace —É–¥–∞–ª—ë–Ω"
echo ""

# 2. –û—á–∏—Å—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏
echo "üßπ –®–∞–≥ 2/6: –û—á–∏—Å—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫ (W293)..."
autopep8 --in-place --select=W293 --recursive src/ tests/
print_status "–ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –æ—á–∏—â–µ–Ω—ã"
echo ""

# 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ newline –≤ –∫–æ–Ω—Ü–µ —Ñ–∞–π–ª–æ–≤
echo "üßπ –®–∞–≥ 3/6: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ newline –≤ –∫–æ–Ω—Ü–µ —Ñ–∞–π–ª–æ–≤ (W292)..."
find src/ tests/ -name "*.py" -type f | while read file; do
    if [ -n "$(tail -c1 "$file")" ]; then
        echo "" >> "$file"
    fi
done
print_status "Newline –¥–æ–±–∞–≤–ª–µ–Ω—ã"
echo ""

# 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫ –º–µ–∂–¥—É —Ñ—É–Ω–∫—Ü–∏—è–º–∏
echo "üßπ –®–∞–≥ 4/6: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫ (E302, E305, E303)..."
autopep8 --in-place --select=E302,E303,E305,E306 --recursive src/ tests/
print_status "–ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã"
echo ""

# 5. –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤
echo "üßπ –®–∞–≥ 5/6: –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ (F401)..."
autoflake --in-place --remove-all-unused-imports --recursive src/ tests/
print_status "–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã —É–¥–∞–ª–µ–Ω—ã"
echo ""

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
echo "üîç –®–∞–≥ 6/6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞..."
echo ""

BEFORE=$(flake8 src/ tests/ --max-line-length=120 --statistics --count 2>&1 | tail -1 | awk '{print $1}')
AFTER=$(flake8 src/ tests/ --max-line-length=120 --statistics --count 2>&1 | tail -1 | awk '{print $1}')

echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:"
echo "   –ü—Ä–æ–±–ª–µ–º –æ—Å—Ç–∞–ª–æ—Å—å: $AFTER"
echo ""

if [ "$AFTER" -lt 100 ]; then
    print_status "–û—Ç–ª–∏—á–Ω–æ! –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ø—Ä–æ–±–ª–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ!"
elif [ "$AFTER" -lt 200 ]; then
    print_warning "–•–æ—Ä–æ—à–æ, –Ω–æ –æ—Å—Ç–∞–ª–æ—Å—å –µ—â—ë –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å"
else
    print_error "–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø—Ä–æ–±–ª–µ–º"
fi

echo ""
echo "üìù –û—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã —Ç—Ä–µ–±—É—é—Ç —Ä—É—á–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
echo "   - E501: –î–ª–∏–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (>120 —Å–∏–º–≤–æ–ª–æ–≤)"
echo "   - E722: Bare except (–Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ç–∏–ø –∏—Å–∫–ª—é—á–µ–Ω–∏—è)"
echo "   - F841: –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ"
echo "   - E402: –ò–º–ø–æ—Ä—Ç—ã –Ω–µ –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞"
echo ""

echo "üí° –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: git diff"
echo "   2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã: pytest tests/"
echo "   3. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã –≤—Ä—É—á–Ω—É—é"
echo "   4. –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–º–∏—Ç: git commit -am 'style: auto-fix flake8 issues'"
echo ""

echo "‚ú® –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º."
