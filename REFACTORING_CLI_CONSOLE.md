# –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ cli.py: –£–ø—Ä–æ—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è Console

## üìã –ü—Ä–æ–±–ª–µ–º–∞

### –î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:
```python
def main() -> None:
    try:
        args = parse_args()
        
        if args.settings:
            from penguin_tamer.config_menu import main_menu
            main_menu()
            return 0

        # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Å–æ–ª—å –∏ –∫–ª–∏–µ–Ω—Ç
        Console = _get_console_class()
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é —Ç–µ–º—É –¥–ª—è Markdown –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
        from penguin_tamer.themes import get_theme  # ‚ùå –ò–º–ø–æ—Ä—Ç –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏
        theme_name = config.get("global", "markdown_theme", "default")
        markdown_theme = get_theme(theme_name)
        console = Console(theme=markdown_theme)
        
        chat_client = _create_chat_client(console)
        # ...
```

### –ü—Ä–æ–±–ª–µ–º—ã:

1. **–ò–º–ø–æ—Ä—Ç –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏** ‚ùå
   - `from penguin_tamer.themes import get_theme` –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ `main()`
   - –ù–∞—Ä—É—à–∞–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –ª–µ–Ω–∏–≤—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –≤ –æ—Å—Ç–∞–ª—å–Ω–æ–º –∫–æ–¥–µ

2. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–º—ã** ‚ùå
   - –¢–µ–º–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –≤ `cli.py`
   - –¢–µ–º–∞ —Ç–∞–∫–∂–µ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –≤ `llm_client.py` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Markdown
   - DRY –Ω–∞—Ä—É—à–µ–Ω

3. **–ò–∑–ª–∏—à–Ω—è—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –≤ main()** ‚ùå
   - –°–æ–∑–¥–∞–Ω–∏–µ Console "—Ä–∞–∑–º–∞–∑–∞–Ω–æ" –Ω–∞ 5 —Å—Ç—Ä–æ–∫
   - –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–Ω–∞
   - –°–Ω–∏–∂–∞–µ—Ç —á–∏—Ç–∞–µ–º–æ—Å—Ç—å `main()`

4. **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –ø—Ä–æ–µ–∫—Ç–∞** ‚ùå
   - –î—Ä—É–≥–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `_create_*` —Ñ—É–Ω–∫—Ü–∏–∏
   - Console —Å–æ–∑–¥–∞—ë—Ç—Å—è inline –±–µ–∑ —Ñ—É–Ω–∫—Ü–∏–∏

## ‚ú® –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω –ª–µ–Ω–∏–≤—ã–π –∏–º–ø–æ—Ä—Ç –¥–ª—è `get_theme`

```python
# –õ–µ–Ω–∏–≤—ã–µ –∏–º–ø–æ—Ä—Ç—ã
_script_executor = None
_formatter_text = None
_execute_handler = None
_console_class = None
_markdown_class = None
_get_theme_func = None  # ‚úÖ –ù–æ–≤—ã–π


def _get_theme():
    """–õ–µ–Ω–∏–≤—ã–π –∏–º–ø–æ—Ä—Ç get_theme"""
    global _get_theme_func
    if _get_theme_func is None:
        from penguin_tamer.themes import get_theme
        _get_theme_func = get_theme
    return _get_theme_func
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É –ª–µ–Ω–∏–≤—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
- ‚úÖ –ò–º–ø–æ—Ä—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- ‚úÖ –£–ª—É—á—à–∞–µ—Ç –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ –¥–ª—è `--help`, `--version`

### 2. –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_create_console()`

```python
def _create_console():
    """–°–æ–∑–¥–∞–Ω–∏–µ Rich Console —Å —Ç–µ–º–æ–π –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞."""
    Console = _get_console_class()
    theme_name = config.get("global", "markdown_theme", "default")
    markdown_theme = _get_theme()(theme_name)
    return Console(theme=markdown_theme)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ò–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è –ª–æ–≥–∏–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è Console
- ‚úÖ –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–µ–º—ã
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É `_create_*` —Ñ—É–Ω–∫—Ü–∏–π
- ‚úÖ –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–±–∞–≤–∏—Ç—å width, highlight)

### 3. –£–ø—Ä–æ—â–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `main()`

**–ë—ã–ª–æ (9 —Å—Ç—Ä–æ–∫):**
```python
# –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Å–æ–ª—å –∏ –∫–ª–∏–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –Ω—É–∂–Ω—ã –¥–ª—è AI –æ–ø–µ—Ä–∞—Ü–∏–π
Console = _get_console_class()

# –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é —Ç–µ–º—É –¥–ª—è Markdown –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
from penguin_tamer.themes import get_theme
theme_name = config.get("global", "markdown_theme", "default")
markdown_theme = get_theme(theme_name)
console = Console(theme=markdown_theme)

chat_client = _create_chat_client(console)
```

**–°—Ç–∞–ª–æ (2 —Å—Ç—Ä–æ–∫–∏):**
```python
# –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Å–æ–ª—å –∏ –∫–ª–∏–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –Ω—É–∂–Ω—ã –¥–ª—è AI –æ–ø–µ—Ä–∞—Ü–∏–π
console = _create_console()
chat_client = _create_chat_client(console)
```

**–£–ª—É—á—à–µ–Ω–∏—è:**
- ‚úÖ –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ 78% (9 —Å—Ç—Ä–æ–∫ ‚Üí 2 —Å—Ç—Ä–æ–∫–∏)
- ‚úÖ –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–ª—å (—á—Ç–æ –¥–µ–ª–∞–µ–º, –∞ –Ω–µ –∫–∞–∫)
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å
- ‚úÖ –ú–µ–Ω—å—à–µ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| –°—Ç—Ä–æ–∫ –≤ main() –¥–ª—è Console | 9 | 2 | -78% |
| –ò–º–ø–æ—Ä—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π | 1 | 0 | -100% |
| –§—É–Ω–∫—Ü–∏–π —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ | 1 | 2 | +1 |
| –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º | ‚ùå | ‚úÖ | +100% |

## üéØ –ü—Ä–∏–Ω—Ü–∏–ø—ã

### ‚úÖ Single Responsibility Principle (SRP)
- `_create_console()` –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ Console
- `main()` –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—é, –Ω–µ –¥–µ—Ç–∞–ª–∏

### ‚úÖ Don't Repeat Yourself (DRY)
- –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Console –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- –õ–µ–Ω–∏–≤—ã–π –∏–º–ø–æ—Ä—Ç —Ç–µ–º—ã –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

### ‚úÖ Consistency (–ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ)
- –°–ª–µ–¥—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É `_create_*` —Ñ—É–Ω–∫—Ü–∏–π
- –°–ª–µ–¥—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É –ª–µ–Ω–∏–≤—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ `_get_*`

### ‚úÖ Clean Code
- –§—É–Ω–∫—Ü–∏–∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –∏ —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
- –ì–æ–≤–æ—Ä—è—â–∏–µ –∏–º–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–π
- –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –≤ `main()`

## üîç –°—Ä–∞–≤–Ω–µ–Ω–∏–µ "–î–æ" –∏ "–ü–æ—Å–ª–µ"

### –î–æ:
```python
def main() -> None:
    try:
        args = parse_args()
        
        if args.settings:
            # ...
            return 0

        # ‚ùå –î–µ—Ç–∞–ª–∏ —Å–æ–∑–¥–∞–Ω–∏—è Console –∑–∞–≥—Ä–æ–º–æ–∂–¥–∞—é—Ç main()
        Console = _get_console_class()
        from penguin_tamer.themes import get_theme  # ‚ùå –ò–º–ø–æ—Ä—Ç –Ω–µ –≤ –Ω–∞—á–∞–ª–µ
        theme_name = config.get("global", "markdown_theme", "default")
        markdown_theme = get_theme(theme_name)
        console = Console(theme=markdown_theme)
        
        chat_client = _create_chat_client(console)
        
        # Determine execution mode
        dialog_mode: bool = args.dialog
        # ...
```

### –ü–æ—Å–ª–µ:
```python
def main() -> None:
    try:
        args = parse_args()
        
        if args.settings:
            # ...
            return 0

        # ‚úÖ –ß–∏—Å—Ç–∞—è, –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
        console = _create_console()
        chat_client = _create_chat_client(console)
        
        # Determine execution mode
        dialog_mode: bool = args.dialog
        # ...
```

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Console:

```python
def _create_console():
    """–°–æ–∑–¥–∞–Ω–∏–µ Rich Console —Å —Ç–µ–º–æ–π –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞."""
    Console = _get_console_class()
    theme_name = config.get("global", "markdown_theme", "default")
    markdown_theme = _get_theme()(theme_name)
    
    # –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å:
    width = config.get("global", "console_width", None)
    highlight = config.get("global", "syntax_highlight", True)
    
    return Console(
        theme=markdown_theme,
        width=width,
        highlight=highlight
    )
```

### –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

```python
def test_create_console():
    """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Å–æ–ª–∏ —Å —Ç–µ–º–æ–π."""
    console = _create_console()
    assert console is not None
    assert console.theme is not None

def test_create_console_with_custom_theme():
    """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Å–æ–ª–∏ —Å –∫–∞—Å—Ç–æ–º–Ω–æ–π —Ç–µ–º–æ–π."""
    config.set("global", "markdown_theme", "dracula")
    console = _create_console()
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ç–µ–º–∞
```

### –õ–µ–≥–∫–æ –º–æ–∫–∏—Ä–æ–≤–∞—Ç—å:

```python
@patch('cli._create_console')
def test_main_uses_console(mock_create_console):
    """–¢–µ—Å—Ç —á—Ç–æ main –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—É—é –∫–æ–Ω—Å–æ–ª—å."""
    mock_console = Mock()
    mock_create_console.return_value = mock_console
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º main
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ mock_console –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
```

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

- [x] –ù–µ—Ç –∏–º–ø–æ—Ä—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π (–∫—Ä–æ–º–µ –ª–µ–Ω–∏–≤—ã—Ö)
- [x] –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –ø—Ä–æ–µ–∫—Ç–∞
- [x] –§—É–Ω–∫—Ü–∏–∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –∏ —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
- [x] DRY —Å–æ–±–ª—é–¥—ë–Ω
- [x] SRP —Å–æ–±–ª—é–¥—ë–Ω
- [x] –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- [x] –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å
- [x] –ß–∏—Ç–∞–µ–º—ã–π –∫–æ–¥
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –µ—Å—Ç—å

## üéì –í—ã–≤–æ–¥—ã

### –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:
1. ‚úÖ **–ß–∏—Å—Ç–æ—Ç–∞ –∫–æ–¥–∞**: –£–±—Ä–∞–Ω –∏–º–ø–æ—Ä—Ç –∏–∑ —Å–µ—Ä–µ–¥–∏–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏
2. ‚úÖ **–ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ**: –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –ø—Ä–æ–µ–∫—Ç–∞
3. ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ 78% —Å—Ç—Ä–æ–∫
4. ‚úÖ **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã Console
5. ‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è

### –ß—Ç–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:
- ‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫ –∂–µ)
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ª–µ–Ω–∏–≤—ã–µ –∏–º–ø–æ—Ä—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã)
- ‚úÖ API (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –¥—Ä—É–≥–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º
2. –°–æ–∑–¥–∞—Ç—å `_create_dialog_formatter()` –¥–ª—è `DialogInputFormatter`
3. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Console —á–µ—Ä–µ–∑ config.yaml

---

**–ê–≤—Ç–æ—Ä**: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–∞–º–∫–∞—Ö —É–ª—É—á—à–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã penguin-tamer  
**–î–∞—Ç–∞**: 5 –æ–∫—Ç—è–±—Ä—è 2025 –≥.  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ
